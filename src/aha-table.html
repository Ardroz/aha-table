<!--
//http://webcomponents.github.io/articles/web-components-best-practices/
-->
<!--
/**
 * @module aha-table
 *
 *
 * Searchable Sortable Editable Paginatable Data Table
 *
 * aha-table is an data table/grid, it cousumes a modal data
 * and modal meta to show a table that can search, sort, edit
 * in place and pagiation, click to edit.
 * 
 * Examples:
 *
 *     <aha-table></aha-table>
 *
 *     <aha-table id="raw" 
 *         selectable="true" 
 *         copyable="true"
 *         seachable="true"
 *         pagesize="20" 
 *         pagesizetitle="Page Size:" 
 *         summarytitle="Viewing">
 *         <aha-column name="title" 
 *             type="string" 
 *             sortable="true"
 *             searchable="true"
 *             required="true"
 *             editable="false"
 *             placeholder="" 
 *             default="" 
 *             hint="Meaning title will help you remember">
 *         </aha-column>
 *     </aha-table/>
 *
 * Available Event Hander:
 *     after-invalid(Object detail)
 *     after-td-click(Object detail)
 *     after-td-dbclick(Object detail)
 *     after-create(Object new_record)
 *     after-copy(Object new_record)
 *     after-remove(Object removed_record)
 *
 * @class aha-table
 * @author Louis Liu<louis.wenchao.liu@gmail.com>
 *
 */
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="aha-table" attributes="selectable searchable copyable removable pagesize searchtitle pagesizetitle summarytitle data-sizelist copyclass removeclass">
	<template>
		<style>
			/* styles for the custom element itself - lowest specificity */
			aha-table { 
				display: block;
			}
			aha-table .rows:hover, 
			aha-table .selected {
				background-color: #f3f3f3;
			}
			aha-table .modified {
				background-color: yellow;
			}
			aha-table .column-head {
				white-space: nowrap;
			}
			aha-table .sortable .column-head, 
			aha-table .hint,
			aha-table .toggle.arrow-up,
			aha-table .toggle.arrow-down {
				cursor: pointer;
			}
			aha-table .sortable:hover {
				text-decoration: underline;
			}
			aha-table .arrow-up,
			aha-table .arrow-down {
				width: 0; 
				height: 0; 
				border-left: 5px solid transparent;
				border-right: 5px solid transparent;
			}
			aha-table .arrow-up {
				border-bottom: 5px solid black;
			}
			aha-table .arrow-down {
				border-top: 5px solid black;
			}
			aha-table .copy-er, 
			aha-table .remove-er {
				cursor: pointer;
			}
			aha-table .searchable input, 
			aha-table .searchable select {
				width: 80px;
			}
			aha-table .pagination {
				margin: 10px;
				text-align: center;
				line-height: 20px;
			}
			aha-table .pagination table {
				border-spacing: 0;
				border: 0;
			}
			aha-table .pagination td {
				padding: 0;
			}
			aha-table .pagination .active button {
				background-color: #ccc;
			}
			aha-table .pagination .available button:hover {
				background-color: #eee;
			}
			aha-table .pagination .disabled button {
				color: #ccc;
			}
			aha-table .pagination button {
				background-color: #fff;
				border: 1px solid #eee;
				min-width: 40px;
				margin: 0;
				line-height: 20px;
				padding: 4px 12px;
				text-decoration: none;
				cursor: pointer;
				user-select: none;
			}
			aha-table .pagination input {
				background-color: #fff;
				border: 1px solid #eee;
				width: 40px;
				line-height: 20px;
				padding: 4px 12px;
			}
			aha-table table .hide {
				display: none !important;
			}
			aha-table table .empty {
				font-style: italic;
				color: #999;
			}
		</style>
		<table id="main" unresolved="">
			<thead>
				<tr>
					<th>
						<input type="checkbox" 
							on-change="{{ selectall }}" 
							class="{{ selectable ? '' : 'hide'}}" 
							title="Select All"/>
						<div title="toggle filters row."
							class="toggle {{ searchable ? 'arrow-up' : 'arrow-down'}}" 
							on-click="{{ toggleFilters }}"></div>
					</th>
					<th template 
						repeat="{{ column in meta }}"
						class="{{ column.sortable ? 'sortable' : ''}} aha-{{column.name}}-th">
						<span class="
							{{ sortedColumn == column.name ? 'sorting ' : 'hide'}}
							{{ descending ? 'arrow-down' : 'arrow-up'}}">
						</span>
						<span 
							class="column-head" 
							on-click="{{ sort }}">
							{{ column.label ? column.label : column.name | capitalize }}
							<sup 
								class="{{ column.hint ? 'hint' : 'hide' }}" 
								title="{{ column.hint }}">i</sup>
						</span>
					</th>
				</tr>
				<tr class="search-head {{ searchable ? '' : 'hide'}}">
					<th>{{searchtitle}} </th>
					<th template
						repeat="{{ column in meta }}">
						<div class="{{ column.searchable ? 'searchable' : 'hide'}}">
							<select 
								on-change="{{ search }}" 
								class="{{ 'choice' === column.type ? '' : 'hide' }}">
									<option template 
										repeat="{{ option in column.options }}"
										value="{{ option.value }}">
										{{ option.label }}
									</option>
							</select>
							<input type="checkbox" 
								on-change="{{ search }}" 
								class="{{ 'boolean' === column.type ? '' : 'hide' }}"/>
							<input type="text" 
								on-keyup="{{ search }}" 
								placeholder?="{{ column.searchplaceholder }}" 
								class="{{ 'choice' !== column.type && 'boolean' !== column.type ? '' : 'hide' }}"/>
						</div>
					</th>
				</tr>
			</thead>
			<tbody>
				<tr template
					repeat="{{ row in data | _sort(sortedColumn, descending) }}"
					if="{{!row._hidden && !row._filtered}}"
					class="rows
						{{ row._hidden || row._filtered ? 'hide' : ''}}
						{{ row._selected ? 'selected' : '' }}
						{{ row._modified ? 'modified' : '' }}
					">
					<td>
						<a class="copy-er {{ copyable ? '' : 'hide' }}" on-click="{{copy}}" title="Copy">
							<i class="{{ copyclass }}">C</i>
						</a>
						<a class="remove-er {{ removable ? '' : 'hide' }}" on-click="{{remove}}" title="Remove">
							<i class="{{ removeclass }}">R</i>
						</a>
						<input type="checkbox" 
						 	title="Click to select"
						 	class="{{ selectable ? '' : 'hide'}}" 
							on-change="{{ select }}" 
							checked?="{{ row._selected }}"/>
					</td>
					<td template 
						repeat="{{ column in meta }}" 
						on-dblclick="{{ dbclick }}" 
						on-click="{{ click }}" 
						title="click to edit" 
						class="aha-td aha-{{column.name}}-td">
						<div class="{{ column.editable && row._editing ? '' : 'hide'}}">
							<select 
								required?="{{ column.required }}"
								class="{{ 'choice' === column.type ? '' : 'hide'}}"
								on-change="{{ save }}" 
								on-blur="{{ save }}">
								<option template
									repeat="{{ option in column.options }}"
									value="{{ option.value }}" 
									selected?="{{ row[column.name] == option.value }}">
									{{ option.label }}
								</option>
							</select>
							<input type="text" 
								required?="{{ column.required }}"
								class="{{ 'string' === column.type ? '' : 'hide'}}"
								on-blur="{{ save }}" 
								value="{{ row[column.name] }}"/>
							<input type="date" 
								required?="{{ column.required }}"
								class="{{ 'date' === column.type ? '' : 'hide'}}"
								on-change="{{ save }}" 
								value="{{ row[column.name] }}"/>
							<input type="time" 
								required?="{{ column.required }}"
								class="{{ 'time' === column.type ? '' : 'hide'}}"
								on-change="{{ save }}" 
								value="{{ row[column.name] }}"/>
							<input type="datetime" 
								required?="{{ column.required }}"
								class="{{ 'datetime' === column.type ? '' : 'hide'}}"
								on-change="{{ save }}" 
								value="{{ row[column.name] }}"/>
							<textarea
								required?="{{ column.required }}"
								class="{{ 'text' === column.type ? '' : 'hide'}}"
								on-mouseover="{{ focus }}"
								on-blur="{{ save }}">{{ row[column.name] }}</textarea>
							<input type="checkbox"
								class="{{ 'boolean' === column.type ? '' : 'hide'}}"
								on-change="{{ save }}" 
								checked?="{{ row[column.name] }}" />
						</div>
						<div class="{{ column.editable && row._editing ? 'hide' : ''}} {{ row[column.name] ? '' : 'empty'}}">
							{{ row[column.name] | translate(column.options, column.placeholder) }}
						</div>
					</td>
				</tr>
			</tbody>
			<tfoot>
				<tr>
					<td colspan="{{meta.length+1}}" class="pagination">
						<table>
							<tr>
								<td class='{{currentpage === 0 ? "disabled" : "available"}} '>
									<button on-click="{{firstPage}}">{{first}}</button>
								</td>
								<td class='{{currentpage === 0 ? "disabled" : "available"}}'>
									<button on-click="{{prevPage}}">{{previous}}</button>
								</td>
								<td template
									repeat="{{ n in currentRange }}" 
									class="{{n == currentpage ? 'active' : 'available'}}" >
									<button data-item="{{n}}" on-click="{{setPage}}">{{n+1}}</button>
								</td>
								<td class='{{pageCount <= 0 || currentpage === pageCount? "disabled" : "available"}}'>
									<button on-click="{{nextPage}}">{{next}}</button>
								</td>
								<td class='{{pageCount <= 0 || currentpage === pageCount? "disabled" : "available"}}'>
									<button on-click="{{lastPage}}">{{last}}</button>
								</td>
								<td>
									{{ pagesizetitle }}
									<select value="{{pagesize}}">
										<option template repeat="{{n in sizelist}}" selected?="{{ n == pagesize }}">{{n}}</option>
									</select>
								</td>
								<td>
									{{ summarytitle }} {{ firstItemIndex }} - {{ lastItemIndex }} of {{ itemCount }}
								</td>
							</tr>
						</table>
					</td>
				</tr>
			</tfoot>
		</table>
	</template>
	<script>
	Polymer('aha-table', {
		//data: instance of the model data
		data: [],
		//meta: instance of the model meta
		meta: [],
		/**
		 * modified: all created or modified row will be referenced here.
		 * it's hard to determine if it's created or modified after multiple
		 * operations, because the element doesn't assume there's an id column,
		 * so you need to determine if by yourself, like check
		 * if the id exists if your model has an id column.
		 */
		modified: [],
		//deleted: all deleted row will be moved here.
		deleted: [],
		//selected: all selected row will be referenced here.
		selected: [],
		//all visiable rows are reference here.
		viewingRow: [], 
		//selectable: if table row is selectable
		selectable: true,
		//copyable: if table row is copyable
		copyable: true,
		//removable: if table row is removable
		removable: true,
		//searchable: if table row is searchable
		searchable: true,
		//searchtitle: text displayed in first column of search row.
		searchtitle: "",
		//sortedColumn: sorted column name
		sortedColumn: "",
		//editingRow: current editing row
		//@type {Object}
		editingRow : null,
		//descending: current sorting order
		descending: false,
		//pagesize: the number of items to show per page
		pagesize: 10,
		//currentpage: the current active page in view
		currentpage: 0,
		//currentRange: the range of pages (e.g 1, 2, 3, 4, 5) to display
		currentRange: [],
		//pageCount: the number of paginated pages
		pageCount: 0,
		//itemCount: the number of visible items
		itemCount: 0,
		//firstItemIndex: the index number of first item in the page, start from 1
		firstItemIndex: 0,
		//lastItemIndex: the index number of last item in the page, start from 1
		lastItemIndex:  0,
		//rangeSize: the total size of the paginated range of items
		rangeSize: 5,
		//sizelist: range list to adjust page size.
		sizelist: [5, 10, 20, 50, 100],
		//previous: label for the Previous button
		previous: "<",
		//next: label for the Next button
		next: ">",
		//first: label for the First page button
		first: "<<",
		//last: label for the Last page button
		last: ">>",
		//pagesizetitle: label for page size box
		pagesizetitle: "",
		//summarytitle: label for table summary area
		summarytitle: "",

		ready: function() {
			this.meta = this.getMeta();
			if (this.dataset.sizelist) {
				this.sizelist = JSON.parse(this.dataset.sizelist);
			}

			this.$.main.setAttribute('resolved', '');
			this.$.main.removeAttribute('unresolved');
		},
		// generate meta from child aha-column elements.
		getMeta: function() {
			var children = this.children || this.impl.children;
			var metas = [];
			for (var i = 0; i < children.length; i++) {
				var meta = {};
				if (children[i].dataset.choices) {
					meta.options = [];
					var choices = JSON.parse(children[i].dataset.choices);
					for (var option in choices) {
						meta.options.push({'value': option, 'label': choices[option]});
					}
				}

				meta.name=children[i].getAttribute('name');
				meta.type=children[i].getAttribute('type');
				meta.sortable=JSON.parse(children[i].getAttribute('sortable').toLowerCase());
				meta.searchable=JSON.parse(children[i].getAttribute('searchable').toLowerCase());
				meta.editable=JSON.parse(children[i].getAttribute('editable').toLowerCase());
				meta.required=JSON.parse(children[i].getAttribute('required').toLowerCase());
				meta.placeholder=children[i].getAttribute('placeholder');
				meta.default=children[i].getAttribute('default');
				meta.hint=children[i].getAttribute('hint');
				meta.searchplaceholder=children[i].getAttribute('searchplaceholder');

				metas.push(meta);
			};
			return metas;
		},

		//=============
		//internal methods
		dataChanged: function() {
			this.refreshPagination();
			if (this.meta.length === 0)  {
				// generate meta from data if meta is not provided from aha-column.
				this.meta = [];
				for (var prop in this.data[0]) {
					if (prop.indexOf('_') !== 0) {//skip internal field
						this.meta.push({
							name: prop,
							label: prop.charAt(0).toUpperCase() + prop.slice(1), 
							type: [true, false].indexOf(this.data[0][prop]) > -1 ? "boolean" : "string", 
							sortable: true, 
							searchable: true, 
							editable: true, 
							required: false
						});
					}
				}
			}
		},
		//translate value to labels for select
		translate: function(value, options, blank){
			if (value != "" && options) {
				for (var i = options.length - 1; i >= 0; i--) {
					if (options[i].value == value) {
						return options[i].label;
					}
				};
			}
			value = value === undefined || value === null ? '' : value;
			return value === "" ? blank : value;
		},
		modifiedChanged: function() {},
		capitalize: function(value) {
			if (!value instanceof String || value.length === 0) 
				return value;
			return value.charAt(0).toUpperCase() + value.slice(1);
		},
		edit: function(e) {
			var row = e.target.templateInstance.model.row;
			row._editing = true;
			if (this.editingRow && this.editingRow != row) {
				this.editingRow._editing = false;
			}
			this.editingRow = row;
			e.target.focus();
		},
		save: function(e) {
			var row    = e.target.templateInstance.model.row;
			var column = e.target.templateInstance.model.column;
			if(row){
				if (column.required && !e.target.validity.valid) {
					this.fire('after-invalid', {"row" : row, "column" : column});
				}

				if ("CHECKBOX" === e.target.type.toUpperCase()) {
					row[column.name] = e.target.checked;
				} else {
					row[column.name] = e.target.value;
				}
				if (this.modified.indexOf(row) === -1) {
					row._modified = true;
					this.modified.push(row);
				}
				row._editing = false;
			}
		},
		sort: function(e, p) {
			var column = e.target.templateInstance.model.column;
			if(column && column.sortable){
				var sortingColumn = column.name;
				if (sortingColumn == this.sortedColumn){
					this.descending = !this.descending;
				} else {
					this.sortedColumn = sortingColumn;
				}
			}
		},
		search: function(e, p) {
			if(e.target.templateInstance.model.column){
				var searchedColumn = e.target.templateInstance.model.column.name;
				for (var i = this.data.length - 1; i >= 0; i--) {
					var row = this.data[i];
					if (row._not_matched_columns === undefined) {
						row._not_matched_columns = [];
					}

					if ("CHECKBOX" === e.target.type.toUpperCase()) {
						row._filtered = e.target.checked && !row[searchedColumn];
						continue;
					}

					if (e.target.value === ""
						|| row[searchedColumn]
						&& row[searchedColumn].toString().slice(0, e.target.value.length).toLowerCase() == e.target.value.toString().toLowerCase()) {
						var _not_matched_index = row._not_matched_columns.indexOf(searchedColumn);
						if (_not_matched_index > -1) {
							row._not_matched_columns.splice(_not_matched_index, 1);
						}
						if (row._not_matched_columns.length === 0) {
							row._filtered = false;
						} else {
							row._filtered = true;
						}
					} else {
						row._filtered = true;
						if (row._not_matched_columns.indexOf(searchedColumn) === -1) {
							row._not_matched_columns.push(searchedColumn);
						}
					}


				};

				this.currentpage = 0;
				this.refreshPagination();
			}
		},
		_sort: function(array, key, desc) {
			if (!array) return;

			return array.sort(function(a, b) {
				var x = a[key], y = b[key];

				if (typeof x === 'undefined' || typeof y === 'undefined') {
					//sort undefined after
					if (typeof x === 'undefined'){
						return !desc;
					}else{
						return desc;
					}
				} else {
					if (typeof x === "string" && typeof y === "string"){
						x = x.toLowerCase();
						y = y.toLowerCase();
					}
					if (desc){
						return ((x < y) ? 1 : ((x > y) ? -1 : 0));
					} else {
						return ((x < y) ? -1 : ((x > y) ? 1 : 0));
					}
				}
			});
		},

		//==================
		//pagination
		firstPage: function() {
			this.currentpage = 0;
		},
		prevPage: function() {
			if ( this.currentpage > 0 ) {
				this.currentpage--;
			}
		},
		nextPage: function() {
			if ( this.currentpage < this.getPageCount() ) {
				this.currentpage++;
			}
		},
		lastPage: function() {
			this.currentpage = this.getPageCount();
		},
		getItemCount: function() {
			var count = 0;
			for (var i = this.data.length - 1; i >= 0; i--) {
				if (!this.data[i]._filtered) {
					count++;
				}
			};
			return count;
		},
		getPageCount: function() {
			return Math.ceil( this.getItemCount() / this.pagesize ) - 1;
		},
		setPage: function(e,d,t) {
			this.currentpage = parseInt( t.dataset.item, 10 );
		},
		currentpageChanged: function(){
			this.filterPage();
			this.currentRange = this.range();
			this.firstItemIndex = this.currentpage * this.pagesize + 1;
			if (this.currentpage === this.pageCount) {
				this.lastItemIndex = this.itemCount;
			} else {
				this.lastItemIndex = (this.currentpage + 1)* this.pagesize;
			}
		},
		pagesizeChanged: function(){
			this.pagesize = parseInt(this.pagesize);
			this.currentpage = 0;
			this.refreshPagination();
		},
		range: function() {
			var paginations = [];
			var start = this.currentpage;

			if ( start > this.getPageCount() - this.rangeSize ) {
				start = this.getPageCount() - this.rangeSize + 1;
			}

			for ( var i = start; i < start + this.rangeSize; i++ ) {
				if (i >= 0) {
					paginations.push(i);
				}
			}
			return paginations;
		},
		filterPage: function() {
			var from = this.currentpage * this.pagesize;
			var to   = from + this.pagesize;
			var count = 0;
			for (var i = 0; i < this.data.length; i++) {
				var row = this.data[i];
				if (!row._filtered) {
					count++;
				}
				if (count <= from || count > to) {
					row._hidden = true;
				} else {
					row._hidden = false;
				}
			};
		},
		refreshPagination: function() {
			// Update current range to account for items per page, range.
			this.currentRange = this.range();

			// Cache the total page count and item count
			this.itemCount = this.getItemCount();
			this.pageCount = this.getPageCount();
			this.firstItemIndex = this.currentpage * this.pagesize + 1;
			if (this.currentpage === this.pageCount) {
				this.lastItemIndex = this.itemCount;
			} else {
				this.lastItemIndex = (this.currentpage + 1)* this.pagesize;
			}

			// Update model bound to UI with filtered range
			this.filterPage();
		},


		//=======================//
		//data manipulation//
		click: function(e,p) {
			var column = e.target.templateInstance.model.column;
			var row = e.target.templateInstance.model.row;
			var detail = {"row" : row, "column" : column};
			if (column.editable) {
				this.edit(e,p);
			}
			this.fire('after-td-click', detail);
		},
		dbclick: function(e,p) {
			var column = e.target.templateInstance.model.column;
			var row = e.target.templateInstance.model.row;
			var detail = {"row" : row, "column" : column};
			this.fire('after-td-dbclick', detail);
		},
		select: function(e,p){
			if (this.selectable) {
				var row = e.target.templateInstance.model.row;
				var index = this.selected.indexOf(row);
				if (index > -1) {
					if(row._selected){
						this.selected.splice(index, 1);
						row._selected = false;
					}
				} else {
					if(!row._selected){
						this.selected.push(row);
						row._selected = true;
					}
				}
				if (!row._editing) {
					e.preventDefault();
				}
			}
		},
		selectall: function(e,p){
			if(e.target.checked){
				for(var i=0;i<this.data.length;i++){
					var row = this.data[i];
					if (!row._filtered && !row._hidden) {
						if(this.selected.indexOf(row)==-1) {
							this.selected.push(row);
						}
						row._selected = true;
					}
				}
			}else{
				this.selected = [];
				for(var i=0;i<this.data.length;i++){
					this.data[i]._selected = false;
				}
			}
		},
		create: function(obj) {
			this.fire('before-create', obj);
			var _new = obj instanceof Object ? obj : {};
			var _default = {_editing: true, _modified: true};
			for (var i = this.meta.length - 1; i >= 0; i--) {
				if (this.meta[i].default && obj[this.meta[i].name] === undefined) {
					_new[this.meta[i].name] = this.meta[i].default;
				}
			};
			this.data.splice(0,0,_new);
			this.modified.push(_new);
			this.fire('after-create', _new);
		},
		copy: function(e, detail, sender) {
			var obj = e.target.templateInstance.model.row;
			this.fire('before-copy', obj);
			var _new = JSON.parse(JSON.stringify(obj));
			if (_new.id) {
				delete _new.id
			}
			if (_new._selected) {
				_new._selected = false;
			}
			_new._modified = true;
			_new._editing = false;
			this.data.splice(0,0,_new);
			this.modified.push(_new);
			this.fire('after-copy', _new);
		},
		remove: function(e, detail, sender) {
			var obj = e.target.templateInstance.model.row;
			this.fire('before-remove', obj);
			var found_index = this.data.indexOf(obj);
			if (found_index !== -1) {
				this.data.splice(found_index,1);
				this.deleted.push(obj);
			}
			var found_index_in_modified = this.modified.indexOf(obj)
			if (found_index_in_modified !== -1) {
				obj._modified = false;
				this.modified.splice(found_index_in_modified,1);
			}
			this.fire('after-remove', obj);
		},
		toggleFilters: function() {
			this.searchable = !this.searchable;
		}
	});

	// Private methods
	</script>
</polymer-element>


<!--
/**
 * @module aha-column
 *
 *
 * child element for aha-table, used for meta building
 *
 *    <aha-column 
 *         name="content"
 *         type="text"
 *         sortable="true"
 *         searchable="true"
 *         required="true"
 *         editable="true"
 *         placeholder="" 
 *         default="">
 *    </aha-column>
 *
 * @class aha-column
 * @author Louis Liu<louis.wenchao.liu@gmail.com>
 *
 */
-->
<polymer-element name="aha-column" attributes="name type sortable searchable editable required placeholder default data-choices hint searchplaceholder">
	<template>
	</template>
	<script>
		Polymer('aha-column', {
			//column name
			name: "",
			//column type: string, text, date, time, datetime, choice
			type: "string",
			sortable: true,
			searchable: true,
			editable: true,
			requried: false,
			//used for placeholder for empty cell.
			placeholder: undefined,
			default: undefined,
			//choices read from data-choices attribute
			options: undefined,
			//hint text in column header
			hint: undefined,
			//placehoder for filter input
			searchplaceholder: undefined
		});
	</script>
</polymer-element>